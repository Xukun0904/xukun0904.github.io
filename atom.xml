<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>XuKun&#39;s Blog</title>
  <icon>https://www.gravatar.com/avatar/60330ab14f15207afe731bc5db91eef1</icon>
  <subtitle>做最好的自己！</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://xukun.fun/"/>
  <updated>2020-07-17T06:33:22.506Z</updated>
  <id>http://xukun.fun/</id>
  
  <author>
    <name>蔚蓝海</name>
    <email>471031576@qq.com</email>
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Shiro修改角色权限清除缓存问题</title>
    <link href="http://xukun.fun/2020/07/17/Shiro%E4%BF%AE%E6%94%B9%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90%E6%B8%85%E9%99%A4%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98/"/>
    <id>http://xukun.fun/2020/07/17/Shiro%E4%BF%AE%E6%94%B9%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90%E6%B8%85%E9%99%A4%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98/</id>
    <published>2020-07-17T05:25:40.000Z</published>
    <updated>2020-07-17T06:33:22.506Z</updated>
    
    <content type="html"><![CDATA[<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>​    使用Shiro中shiro:hasPermission标签，修改角色权限后相同角色下各个用户权限不一致问题。在角色管理中修改当前登陆人的角色权限，当前用户的权限更新了，但是这个角色下其它用户的权限还是修改前的权限。</p><h1 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h1><p>​    shiro:hasPermission进行比较权限时，先通过CacheManager获取了Redis中的当前用户的权限缓存。</p><img src="/2020/07/17/Shiro%E4%BF%AE%E6%94%B9%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90%E6%B8%85%E9%99%A4%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98/20200717142806.png" class=""><p>​    而更新角色权限后，调用Realm中的内置的clearCache方法清除权限缓存，只清除了当前用户的权限缓存。</p><img src="/2020/07/17/Shiro%E4%BF%AE%E6%94%B9%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90%E6%B8%85%E9%99%A4%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98/20200717135435.png" class=""><h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>​    需要清除该角色下所有用户的权限缓存，通过RedisSessionDAO获取所有用户信息，然后循环清除指定用户权限缓存。若需要清除指定用户权限缓存，可将SimplePrincipalCollection对象强转成用户对象，再根据传入用户主键集合判断是否需要清除权限缓存。</p><img src="/2020/07/17/Shiro%E4%BF%AE%E6%94%B9%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90%E6%B8%85%E9%99%A4%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98/20200717140127.png" class="">]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h1&gt;&lt;p&gt;​    使用Shiro中shiro:hasPermission标签，修改角色权限后相同角色下各个用户权限不一致问题。在角色
      
    
    </summary>
    
    
      <category term="问题记录" scheme="http://xukun.fun/categories/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
    
      <category term="MyBatis-Plus" scheme="http://xukun.fun/tags/MyBatis-Plus/"/>
    
  </entry>
  
  <entry>
    <title>Mybatis-Plus分页多次查询获取相同数据问题</title>
    <link href="http://xukun.fun/2020/03/17/Mybatis-Plus%E5%88%86%E9%A1%B5%E5%A4%9A%E6%AC%A1%E6%9F%A5%E8%AF%A2%E8%8E%B7%E5%8F%96%E7%9B%B8%E5%90%8C%E6%95%B0%E6%8D%AE%E9%97%AE%E9%A2%98/"/>
    <id>http://xukun.fun/2020/03/17/Mybatis-Plus%E5%88%86%E9%A1%B5%E5%A4%9A%E6%AC%A1%E6%9F%A5%E8%AF%A2%E8%8E%B7%E5%8F%96%E7%9B%B8%E5%90%8C%E6%95%B0%E6%8D%AE%E9%97%AE%E9%A2%98/</id>
    <published>2020-03-17T05:53:33.000Z</published>
    <updated>2020-03-17T06:23:38.997Z</updated>
    
    <content type="html"><![CDATA[<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>​    使用MyBatis-Plus 3.1.0，在做一个千万级数据从MySQL导入ElasticSearch的测试脚本中，由于数据量过大，不能一次获取，所以需要分页，循环递增页码来获取数据中发现每次分页查询结果都一样。</p><h1 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h1><p>​    MyBatis 判断是否需要使用一级缓存的代码早于 MyBatis-Plus 分页插件拦截的代码执行，导致获取的结果一直都是一级缓存中的数据。</p><img src="/2020/03/17/Mybatis-Plus%E5%88%86%E9%A1%B5%E5%A4%9A%E6%AC%A1%E6%9F%A5%E8%AF%A2%E8%8E%B7%E5%8F%96%E7%9B%B8%E5%90%8C%E6%95%B0%E6%8D%AE%E9%97%AE%E9%A2%98/20200317140837.png" class=""><img src="/2020/03/17/Mybatis-Plus%E5%88%86%E9%A1%B5%E5%A4%9A%E6%AC%A1%E6%9F%A5%E8%AF%A2%E8%8E%B7%E5%8F%96%E7%9B%B8%E5%90%8C%E6%95%B0%E6%8D%AE%E9%97%AE%E9%A2%98/20200317140911.png" class=""><h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>​    在对应XML的SELECT标签中，加入flushCache=”true”属性，调用此查询方法会自动清除一级缓存和二级缓存。</p><img src="/2020/03/17/Mybatis-Plus%E5%88%86%E9%A1%B5%E5%A4%9A%E6%AC%A1%E6%9F%A5%E8%AF%A2%E8%8E%B7%E5%8F%96%E7%9B%B8%E5%90%8C%E6%95%B0%E6%8D%AE%E9%97%AE%E9%A2%98/20200317141226.png" class="">]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h1&gt;&lt;p&gt;​    使用MyBatis-Plus 3.1.0，在做一个千万级数据从MySQL导入ElasticSearch的测试脚本中
      
    
    </summary>
    
    
      <category term="问题记录" scheme="http://xukun.fun/categories/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
    
      <category term="MyBatis-Plus" scheme="http://xukun.fun/tags/MyBatis-Plus/"/>
    
  </entry>
  
</feed>
